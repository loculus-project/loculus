# This file is deployed manually, it does not get automatically deployed from the git repository: with access to our kubernetes cluster run `kubectl apply -f appset.yaml`
apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: pp-preview
  namespace: argocd
  resourceVersion: "33491144"
spec:
  goTemplate: true
  generators:
    - pullRequest:
        github:
          owner: loculus-project
          labels:
            - preview
          repo: loculus
          tokenRef:
            key: token
            secretName: github-access-token
        requeueAfterSeconds: 60
    - git:
        repoURL: https://github.com/loculus-project/argocd_metadata.git
        revision: HEAD
        files:
          - path: "config.json"
  template:
    metadata:
      name: 'pp-{{ (printf "%.25s" .branch) | replace "_" "-" | replace "/" "-" | trimSuffix "-" | lower }}-{{.number}}'
    spec:
      destination:
        server: 'https://kubernetes.default.svc'
        namespace: 'prev-{{ (printf "%.25s" .branch) | replace "_" "-" | replace "/" "-" | trimSuffix "-" | lower  }}'
      project: default
      source:
        path: 'kubernetes/loculus/'
        repoURL: 'https://github.com/loculus-project/loculus.git'
        targetRevision: '{{.branch}}'
        helm:
          parameters:
            - name: shortbranch
              value: '{{ (printf "%.25s" .branch) | replace "_" "-" | replace "/" "-" | trimSuffix "-" | lower  }}'
            - name: namespace # TODO(https://github.com/loculus-project/loculus/issues/979) delete this once no unsynced up branches need it
              value: 'preview-{{ (printf "%.25s" .branch) | replace "_" "-" | replace "/" "-" | trimSuffix "-" | lower }}'
            - name: sha
              value: '{{.head_short_sha_7}}'
            - name: branch
              value: '{{.branch}}'
            - name: host
              value: '{{ (printf "%.25s" .branch) | replace "_" "-" | replace "/" "-" | trimSuffix "-" | lower  }}.loculus.org'
      syncPolicy:
        syncOptions:
          - CreateNamespace=true
        automated:
          selfHeal: true
          prune: true
