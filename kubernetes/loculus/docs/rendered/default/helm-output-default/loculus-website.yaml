# Source: loculus/templates/loculus-website.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: loculus-website
  annotations:
    argocd.argoproj.io/sync-options: Replace=true
spec:
  replicas: 1
  selector:
    matchLabels:
      app: loculus
      component: website
  template:
    metadata:
      annotations:
        timestamp: ""
      labels:
        app: loculus
        component: website
    spec:
      
      initContainers:
        - name: config-processor-loculus-website-config
          image: ghcr.io/loculus-project/config-processor:latest
          imagePullPolicy: Always
          volumeMounts:
            - name: loculus-website-config
              mountPath: /input
            - name: loculus-website-config-processed
              mountPath: /output
          command: ["python3"]
          args: ["/app/config-processor.py", "/input", "/output"]
          resources:
            requests:
              cpu: 50m
              memory: 64Mi
            limits:
              cpu: 500m
              memory: 256Mi
          env:
            - name: LOCULUSSUB_smtpPassword
              valueFrom:
                secretKeyRef:
                  name: smtp-password
                  key: secretKey
            - name: LOCULUSSUB_insdcIngestUserPassword
              valueFrom:
                secretKeyRef:
                  name: service-accounts
                  key: insdcIngestUserPassword
            - name: LOCULUSSUB_preprocessingPipelinePassword
              valueFrom:
                secretKeyRef:
                  name: service-accounts
                  key: preprocessingPipelinePassword
            - name: LOCULUSSUB_externalMetadataUpdaterPassword
              valueFrom:
                secretKeyRef:
                  name: service-accounts
                  key: externalMetadataUpdaterPassword
            - name: LOCULUSSUB_backendUserPassword
              valueFrom:
                secretKeyRef:
                  name: service-accounts
                  key: backendUserPassword
            - name: LOCULUSSUB_backendKeycloakClientSecret
              valueFrom:
                secretKeyRef:
                  name: backend-keycloak-client-secret
                  key: backendKeycloakClientSecret
            - name: LOCULUSSUB_orcidSecret
              valueFrom:
                secretKeyRef:
                  name: orcid
                  key: orcidSecret
      containers:
        - name: website
          image: "ghcr.io/loculus-project/website:latest"
          imagePullPolicy: "Always"
          
          resources:
            limits:
              memory: 1Gi
            requests:
              cpu: 100m
              memory: 200Mi
          ports:
            - containerPort: 3000
          volumeMounts:
            - name: loculus-website-config-processed
              mountPath: /config
          livenessProbe:
            httpGet:
              path: /
              port: 3000
            initialDelaySeconds: 30
            periodSeconds: 10
          readinessProbe:
            httpGet:
              path: /
              port: 3000
            initialDelaySeconds: 5
            periodSeconds: 5
      imagePullSecrets:
        - name: custom-website-sealed-secret
      volumes:

        - name: loculus-website-config
          configMap:
            name: loculus-website-config
        - name: loculus-website-config-processed
          emptyDir: {}
---
