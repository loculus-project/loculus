{{- $commonMetadata := (include "loculus.commonMetadata" . | fromYaml).fields }}
{{- $importScriptLines := .Files.Lines "silo_import_job.sh" }}
{{- $importScriptWrapperLines := .Files.Lines "silo_import_wrapper.sh" }}

{{- range $key, $instance := (.Values.organisms | default .Values.defaultOrganisms) }}
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: lapis-silo-database-config-{{ $key }}
data:
  {{- with ($instance.schema | include "loculus.patchMetadataSchema" | fromYaml) }}
  database_config.yaml: |
    schema:
      {{- $use_segments := false }} # Default to false
      {{- $nucleotideSequences := .nucleotideSequences | default (list "main")}}
      {{- if or (lt (len $nucleotideSequences) 1) (and (eq (len $nucleotideSequences) 1) (eq (index $nucleotideSequences 0) "main")) }}
      {{- $use_segments = false }}
      {{- else }}
      {{- $use_segments = true }}
      {{- end }}
      instanceName: {{ .organismName }}
      opennessLevel: OPEN
      metadata:
      {{- range (concat $commonMetadata .metadata) }}
      {{- $currentItem := . }}
      {{- if and $use_segments .perSegment }}
        {{- range $segment := $nucleotideSequences }}
        - name: {{ printf "%s_%s" $currentItem.name $segment | quote }}
          {{- $type := default "string" $currentItem.type }}
          type: {{ ($type | eq "timestamp") | ternary "int" (($type | eq "authors") | ternary "string" $type) }}
          {{- if $currentItem.generateIndex }}
          generateIndex: {{ $currentItem.generateIndex }}
          {{- end }}
        {{- end }}
      {{- else }}
        - name: {{ .name }}
          {{- $type := default "string" .type }}
          type: {{ ($type | eq "timestamp") | ternary "int" (($type | eq "authors") | ternary "string" $type) }}
          {{- if .generateIndex }}
          generateIndex: {{ .generateIndex }}
          {{- end }}
      {{- end }}
      {{- end }}
      primaryKey: accessionVersion
      {{- .silo | toYaml | nindent 6 }}
  {{- end }}

  preprocessing_config.yaml: |
    ndjsonInputFilename: data.ndjson.zst
    pangoLineageDefinitionFilename: pangolineage_alias.json
    referenceGenomeFilename: reference_genomes.json

  reference_genomes.json: |
    {{ $instance.referenceGenomes | toJson }}

  silo_import_job.sh: |
    {{ range $importScriptLines }}
    {{ . }}{{ end }}

  silo_import_wrapper.sh: |
    {{ range $importScriptWrapperLines }}
    {{ . }}{{ end }}

  pangolineage_alias.json: |
    {{ $instance.pangolineage_alias | default dict | toJson }}
{{- end }}