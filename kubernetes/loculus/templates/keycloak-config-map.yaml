{{- $keycloakHost := printf "authentication-%s" .Values.host }}
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: keycloak-config
data:
  keycloak-config.json: |
    {
      "realm": "loculusRealm",
      "enabled": true,
      "registrationAllowed": true,
      "accessTokenLifespan": 36000,
      "ssoSessionIdleTimeout": 36000,
      "users": [
        {{- $browsers := list "firefox" "webkit" "chromium"}}
        {{- range $_, $browser := $browsers }}
          {{- range $index, $_ := until 20}}
        {
          "username": "testuser_{{$index}}_{{$browser}}",
          "enabled": true,
          "email": "testuser_{{$index}}_{{$browser}}@keycloak.org",
          "firstName": "Test",
          "lastName": "User",
          "credentials": [
            {
              "type": "password",
              "value": "testuser_{{$index}}_{{$browser}}"
            }
          ],
          "realmRoles": [
            "user",
            "offline_access"
          ],
          "clientRoles": {
            "account": [
              "manage-account"
            ]
          }
        },
          {{ end }}
        {{ end }}
        {
          "username": "testuser",
          "enabled": true,
          "email": "testuser@keycloak.org",
          "firstName": "Test",
          "lastName": "User",
          "credentials": [
            {
              "type": "password",
              "value": "testuser"
            }
          ],
          "realmRoles": [
            "user",
            "offline_access"
          ],
          "clientRoles": {
            "account": [
              "manage-account"
            ]
          }
        },
        {
          "username": "insdc_ingest_user",
          "enabled": true,
          "email": "insdc_ingest_user@keycloak.org",
          "firstName": "INSDC Ingest",
          "lastName": "User",
          "credentials": [
            {
              "type": "password",
              "value": "insdc_ingest_user"
            }
          ],
          "realmRoles": [
            "user",
            "offline_access"
          ],
          "clientRoles": {
            "account": [
              "manage-account"
            ]
          }
        },
        {
          "username": "dummy_preprocessing_pipeline",
          "enabled": true,
          "email": "dummy_preprocessing_pipeline@keycloak.org",
          "firstName": "Dummy",
          "lastName": "Preprocessing",
          "credentials": [
            {
              "type": "password",
              "value": "dummy_preprocessing_pipeline"
            }
          ],
          "realmRoles": [
            "preprocessing_pipeline",
            "offline_access"
          ],
          "clientRoles": {
            "account": [
              "manage-account"
            ]
          }
        },
        {
          "username": "silo_import_job",
          "enabled": true,
          "email": "silo_import_job@keycloak.org",
          "firstName": "SILO",
          "lastName": "ImportJob",
          "credentials": [
            {
              "type": "password",
              "value": "silo_import_job"
            }
          ],
          "realmRoles": [
            "get_released_data",
            "offline_access"
          ],
          "clientRoles": {
            "account": [
              "manage-account"
            ]
          }
        },
        {
          "username": "backend",
          "enabled": true,
          "email": "nothing@void.o",
          "firstName": "Backend",
          "lastName": "Technical-User",
          "credentials": [
            {
              "type": "password",
              "value": "backend"
            }
          ],
          "clientRoles": {
            "realm-management": [
              "view-users"
            ],
            "account": [
              "manage-account"
            ]
          }
        }
      ],
      "roles": {
        "realm": [
          {
            "name": "user",
            "description": "User privileges"
          },
          {
            "name": "admin",
            "description": "Administrator privileges"
          },
          {
            "name": "preprocessing_pipeline",
            "description": "Preprocessing pipeline privileges"
          },
          {
            "name": "get_released_data",
            "description": "Privileges for getting released data"
          }
        ]
      },
      "clients": [
        {
          "clientId": "test-cli",
          "enabled": true,
          "publicClient": true,
          "directAccessGrantsEnabled": true,
          "redirectUris": [
            "*"
          ]
        },
              {
          
          "clientId" : "account-console2",
          "name" : "${client_account-console}",
          "description" : "",
          "rootUrl" : "${authBaseUrl}",
          "adminUrl" : "",
          "baseUrl" : "/realms/loculusRealm/account/",
          "surrogateAuthRequired" : false,
          "enabled" : true,
          "alwaysDisplayInConsole" : false,
          "clientAuthenticatorType" : "client-secret",
          "redirectUris" : [ "/realms/loculusRealm/account/*" ],
          "webOrigins" : [ "+" ],
          "notBefore" : 0,
          "bearerOnly" : false,
          "consentRequired" : false,
          "standardFlowEnabled" : true,
          "implicitFlowEnabled" : false,
          "directAccessGrantsEnabled" : false,
          "serviceAccountsEnabled" : false,
          "publicClient" : true,
          "frontchannelLogout" : false,
          "protocol" : "openid-connect",
          "attributes" : {
            "oidc.ciba.grant.enabled" : "false",
            "backchannel.logout.session.required" : "true",
            "post.logout.redirect.uris" : "+",
            "oauth2.device.authorization.grant.enabled" : "false",
            "display.on.consent.screen" : "false",
            "pkce.code.challenge.method" : "S256",
            "backchannel.logout.revoke.offline.tokens" : "false"
          },
          "authenticationFlowBindingOverrides" : { },
          "fullScopeAllowed" : false,
          "nodeReRegistrationTimeout" : 0,
          "protocolMappers" : [ {
           
            "name" : "audience resolve",
            "protocol" : "openid-connect",
            "protocolMapper" : "oidc-audience-resolve-mapper",
            "consentRequired" : false,
            "config" : { }
          } ],
          "defaultClientScopes" : [ "web-origins", "acr", "profile", "roles", "email" ],
          "optionalClientScopes" : [ "address", "phone", "offline_access", "microprofile-jwt" ]
        }
      ],
      "attributes": {
        {{- if eq .Values.environment "server" }}
        "frontendUrl": "https://{{ $keycloakHost }}"
        {{- else if .Values.codespaceName }}
        "frontendUrl": "https://{{ .Values.codespaceName }}-8083.app.github.dev"
        {{- else }}
        "frontendUrl": "http://localhost:8083"
        {{- end }}
         , "userProfileEnabled" : "true"
      },
      "components": {
            "org.keycloak.userprofile.UserProfileProvider" : [ {
          "providerId" : "declarative-user-profile",
          "subComponents" : { },
          "config" : {
            "kc.user.profile.config" : [ "{\"attributes\":[{\"name\":\"username\",\"displayName\":\"${username}\",\"validations\":{\"length\":{\"min\":3,\"max\":255},\"username-prohibited-characters\":{},\"up-username-not-idn-homograph\":{}},\"permissions\":{\"view\":[\"admin\",\"user\"],\"edit\":[\"admin\",\"user\"]}},{\"name\":\"email\",\"displayName\":\"${email}\",\"validations\":{\"email\":{},\"length\":{\"max\":255}},\"required\":{\"roles\":[\"user\"]},\"permissions\":{\"view\":[\"admin\",\"user\"],\"edit\":[\"admin\",\"user\"]}},{\"name\":\"firstName\",\"displayName\":\"${firstName}\",\"validations\":{\"length\":{\"max\":255},\"person-name-prohibited-characters\":{}},\"required\":{\"roles\":[\"user\"]},\"permissions\":{\"view\":[\"admin\",\"user\"],\"edit\":[\"admin\",\"user\"]}},{\"name\":\"lastName\",\"displayName\":\"${lastName}\",\"validations\":{\"length\":{\"max\":255},\"person-name-prohibited-characters\":{}},\"required\":{\"roles\":[\"user\"]},\"permissions\":{\"view\":[\"admin\",\"user\"],\"edit\":[\"admin\",\"user\"]}},{\"name\":\"university\",\"displayName\":\"University / Organisation\",\"validations\":{},\"annotations\":{},\"required\":{\"roles\":[\"admin\",\"user\"]},\"permissions\":{\"view\":[],\"edit\":[\"admin\",\"user\"]}},{\"name\":\"orcid\",\"displayName\":\"\",\"permissions\":{\"edit\":[\"admin\"],\"view\":[\"admin\",\"user\"]},\"annotations\":{},\"validations\":{}}],\"groups\":[]}" ]
           }
        } ]
      },
      "loginTheme": "loculus",
        "identityProviders" : [ {
        "alias" : "orcid",
        "providerId" : "orcid",
        "enabled" : true,
        "updateProfileFirstLoginMode" : "on",
        "trustEmail" : false,
        "storeToken" : false,
        "addReadTokenRoleOnCreate" : false,
        "authenticateByDefault" : false,
        "linkOnly" : false,
        "firstBrokerLoginFlowAlias" : "first broker login",
        "config" : {
          "clientSecret" : "65897b89-a888-427d-8828-1f1dd97bf6c1",
          "clientId" : "APP-P1P7N7T9YVBHQ4EH"
        }
      } ],
    "identityProviderMappers" : [ {
    "name" : "username mapper",
    "identityProviderAlias" : "orcid",
    "identityProviderMapper" : "hardcoded-attribute-idp-mapper",
    "config" : {
      "syncMode" : "INHERIT",
      "attribute" : "username"
    }
    },{
      "name" : "orcid",
      "identityProviderAlias" : "orcid",
      "identityProviderMapper" : "orcid-user-attribute-mapper",
      "config" : {
        "syncMode" : "INHERIT",
        "jsonField" : "orcid-identifier",
        "userAttribute" : "orcid.path"
      }
    } ]
    }
