{{- $dockerTag := include "loculus.dockerTag" .Values }}
{{- if not .Values.disableEnaSubmission }}
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: loculus-ena-submission
  annotations:
    argocd.argoproj.io/sync-options: Replace=true
spec:
  replicas: 1
  selector:
    matchLabels:
      app: loculus
      component: loculus-ena-submission
  template:
    metadata:
      annotations:
        timestamp: {{ now | quote }}
      labels:
        app: loculus
        component: loculus-ena-submission
    spec:
      {{- include "possiblePriorityClassName" . | nindent 6 }}
      initContainers:
        {{- if .Values.enableMockEna }}
        - name: wait-for-mock-ena
          image: nicolaka/netshoot:latest
          command:
            - sh
            - -c
            - |
              echo "Waiting for mock-ena-service to be ready..."
              until curl -sf http://mock-ena-service/; do
                echo "Mock ENA not ready yet, waiting..."
                sleep 2
              done
              # Resolve mock-ena-service IP and write to shared hosts file
              MOCK_IP=$(getent hosts mock-ena-service | awk '{print $1}')
              echo "Mock ENA is ready at IP: $MOCK_IP"
              echo "$MOCK_IP wwwdev.ebi.ac.uk www.ebi.ac.uk" > /shared-hosts/mock-ena-hosts
              # Fetch CA certificate for Java truststore
              echo "Fetching mock ENA CA certificate..."
              curl -sf http://mock-ena-service/ca.crt > /shared-hosts/mock-ena-ca.crt
              echo "CA certificate saved"
          volumeMounts:
            - name: shared-hosts
              mountPath: /shared-hosts
        {{- end }}
        - name: ena-submission-flyway
          image: "ghcr.io/loculus-project/ena-submission-flyway:{{ $dockerTag }}"
          resources:
            requests:
              cpu: 100m
              memory: 128Mi
            limits:
              cpu: 500m
              memory: 256Mi
          command: ['flyway', 'migrate']
          env:
            - name: FLYWAY_URL
              valueFrom:
                secretKeyRef:
                  name: database
                  key: url
            - name: FLYWAY_USER
              valueFrom:
                secretKeyRef:
                  name: database
                  key: username
            - name: FLYWAY_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: database
                  key: password
      containers:
        - name: ena-submission
          image: "ghcr.io/loculus-project/ena-submission:{{ $dockerTag }}"
          imagePullPolicy: {{ $.Values.imagePullPolicy }}
          {{- include "loculus.resources" (list "ena-submission" $.Values) | nindent 10 }}
          env:
            - name: EXTERNAL_METADATA_UPDATER_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: service-accounts
                  key: externalMetadataUpdaterPassword
            - name: DB_URL
              valueFrom:
                secretKeyRef:
                  name: database
                  key: url
            - name: DB_USERNAME
              valueFrom:
                secretKeyRef:
                  name: database
                  key: username
            - name: DB_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: database
                  key: password
            - name: SLACK_HOOK
              valueFrom:
                secretKeyRef:
                  name: slack-notifications
                  key: slack-hook
            - name: SLACK_TOKEN
              valueFrom:
                secretKeyRef:
                  name: slack-notifications
                  key: slack-token
            - name: SLACK_CHANNEL_ID
              valueFrom:
                secretKeyRef:
                  name: slack-notifications
                  key: slack-channel-id
            - name: ENA_USERNAME
              valueFrom:
                secretKeyRef:
                  name: ena-submission
                  key: username
            - name: ENA_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: ena-submission
                  key: password
            {{- if .Values.enableMockEna }}
            - name: MOCK_ENA_URL
              # Use internal service name with HTTP for mock ENA
              value: "http://mock-ena-service"
            {{- end }}
          {{- if .Values.enableMockEna }}
          command:
            - /usr/local/bin/_entrypoint.sh
            - /bin/bash
            - -c
            - |
              set -e
              # Append mock ENA hosts to /etc/hosts for webin-cli
              if [ -f /shared-hosts/mock-ena-hosts ]; then
                cat /shared-hosts/mock-ena-hosts >> /etc/hosts 2>/dev/null || true
                echo "Mock ENA hosts entries:"
                cat /shared-hosts/mock-ena-hosts
              fi
              # Import mock ENA CA cert into Java truststore for webin-cli
              if [ -f /shared-hosts/mock-ena-ca.crt ]; then
                echo "Importing mock ENA CA certificate into Java truststore..."
                # Find Java cacerts location
                JAVA_BIN=$(which java)
                JAVA_HOME=$(dirname $(dirname $(readlink -f $JAVA_BIN)))
                CACERTS="$JAVA_HOME/lib/security/cacerts"
                if [ -f "$CACERTS" ]; then
                  keytool -importcert -trustcacerts -noprompt \
                    -alias mock-ena-ca \
                    -file /shared-hosts/mock-ena-ca.crt \
                    -keystore "$CACERTS" \
                    -storepass changeit 2>/dev/null || echo "CA cert may already be imported"
                  echo "CA certificate imported to $CACERTS"
                else
                  echo "Warning: Java cacerts not found at $CACERTS"
                fi
              fi
              exec ena_deposition --config-file=/config/config.yaml
          {{- else }}
          args:
            - ena_deposition
            - "--config-file=/config/config.yaml"
          {{- end }}
          volumeMounts:
            - name: loculus-ena-submission-config-volume
              mountPath: /config/config.yaml
              subPath: config.yaml
            {{- if .Values.enableMockEna }}
            - name: shared-hosts
              mountPath: /shared-hosts
            {{- end }}
      volumes:
        - name: loculus-ena-submission-config-volume
          configMap:
            name: loculus-ena-submission-config
        {{- if .Values.enableMockEna }}
        - name: shared-hosts
          emptyDir: {}
        {{- end }}
---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: loculus-get-ena-submission-list-cronjob
spec:
   # run twice a day to ensure at least once no overlap with argo cd refresh
  schedule: "0 1,13 * * *"
  startingDeadlineSeconds: 60
  concurrencyPolicy: Forbid
  jobTemplate:
    spec:
      activeDeadlineSeconds: {{ $.Values.getSubmissionListLimitSeconds }}
      template:
        metadata:
          labels:
            app: loculus
            component: loculus-get-ena-submission-list-cronjob
          annotations:
            argocd.argoproj.io/sync-options: Replace=true
        spec:
          {{- include "possiblePriorityClassName" . | nindent 10 }}
          restartPolicy: Never
          containers:
            - name: ena-submission
              image: "ghcr.io/loculus-project/ena-submission:{{ $dockerTag }}"
              imagePullPolicy: {{ $.Values.imagePullPolicy }}
              {{- include "loculus.resources" (list "ena-submission-list-cronjob" $.Values) | nindent 14 }}
              env:
                - name: EXTERNAL_METADATA_UPDATER_PASSWORD
                  valueFrom:
                    secretKeyRef:
                      name: service-accounts
                      key: externalMetadataUpdaterPassword
                - name: DB_URL
                  valueFrom:
                    secretKeyRef:
                      name: database
                      key: url
                - name: DB_USERNAME
                  valueFrom:
                    secretKeyRef:
                      name: database
                      key: username
                - name: DB_PASSWORD
                  valueFrom:
                    secretKeyRef:
                      name: database
                      key: password
                - name: SLACK_HOOK
                  valueFrom:
                    secretKeyRef:
                      name: slack-notifications
                      key: slack-hook
                - name: SLACK_TOKEN
                  valueFrom:
                    secretKeyRef:
                      name: slack-notifications
                      key: slack-token
                - name: SLACK_CHANNEL_ID
                  valueFrom:
                    secretKeyRef:
                      name: slack-notifications
                      key: slack-channel-id
              args:
                - python
                - "scripts/get_ena_submission_list.py"
                - "--config-file=/config/config.yaml"
              volumeMounts:
                - name: loculus-ena-submission-config-volume
                  mountPath: /config/config.yaml
                  subPath: config.yaml
          volumes:
            - name: loculus-ena-submission-config-volume
              configMap:
                name: loculus-ena-submission-config
{{- end }}
