{{- $dockerTag := include "loculus.dockerTag" .Values }}
{{- if not .Values.disableEnaSubmission }}
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: loculus-ena-submission
  annotations:
    argocd.argoproj.io/sync-options: Replace=true
spec:
  replicas: 1
  selector:
    matchLabels:
      app: loculus
      component: loculus-ena-submission
  template:
    metadata:
      annotations:
        timestamp: {{ now | quote }}
      labels:
        app: loculus
        component: loculus-ena-submission
    spec:
      {{- include "possiblePriorityClassName" . | nindent 6 }}
      {{- if .Values.enableMockEna }}
      hostAliases:
        - ip: "127.0.0.1"
          hostnames:
            - "wwwdev.ebi.ac.uk"
            - "www.ebi.ac.uk"
            - "webin2.ebi.ac.uk"
      {{- end }}
      initContainers:
        {{- if .Values.enableMockEna }}
        - name: wait-for-mock-ena
          image: nicolaka/netshoot:latest
          command:
            - sh
            - -c
            - |
              echo "Waiting for mock-ena-service to be ready..."
              until curl -sf http://mock-ena-service/; do
                echo "Mock ENA not ready yet, waiting..."
                sleep 2
              done
              echo "Mock ENA is ready"
        {{- end }}
        - name: ena-submission-flyway
          image: "ghcr.io/loculus-project/ena-submission-flyway:{{ $dockerTag }}"
          resources:
            requests:
              cpu: 100m
              memory: 128Mi
            limits:
              cpu: 500m
              memory: 256Mi
          command: ['flyway', 'migrate']
          env:
            - name: FLYWAY_URL
              valueFrom:
                secretKeyRef:
                  name: database
                  key: url
            - name: FLYWAY_USER
              valueFrom:
                secretKeyRef:
                  name: database
                  key: username
            - name: FLYWAY_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: database
                  key: password
      containers:
        - name: ena-submission
          image: "ghcr.io/loculus-project/ena-submission:{{ $dockerTag }}"
          imagePullPolicy: {{ $.Values.imagePullPolicy }}
          {{- include "loculus.resources" (list "ena-submission" $.Values) | nindent 10 }}
          env:
            - name: EXTERNAL_METADATA_UPDATER_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: service-accounts
                  key: externalMetadataUpdaterPassword
            - name: DB_URL
              valueFrom:
                secretKeyRef:
                  name: database
                  key: url
            - name: DB_USERNAME
              valueFrom:
                secretKeyRef:
                  name: database
                  key: username
            - name: DB_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: database
                  key: password
            - name: SLACK_HOOK
              valueFrom:
                secretKeyRef:
                  name: slack-notifications
                  key: slack-hook
            - name: SLACK_TOKEN
              valueFrom:
                secretKeyRef:
                  name: slack-notifications
                  key: slack-token
            - name: SLACK_CHANNEL_ID
              valueFrom:
                secretKeyRef:
                  name: slack-notifications
                  key: slack-channel-id
            - name: ENA_USERNAME
              valueFrom:
                secretKeyRef:
                  name: ena-submission
                  key: username
            - name: ENA_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: ena-submission
                  key: password
            {{- if .Values.enableMockEna }}
            - name: MOCK_ENA_URL
              # Use internal service name with HTTP for mock ENA
              value: "http://mock-ena-service"
            {{- end }}
          args:
            - ena_deposition
            - "--config-file=/config/config.yaml"
          volumeMounts:
            - name: loculus-ena-submission-config-volume
              mountPath: /config/config.yaml
              subPath: config.yaml
        {{- if .Values.enableMockEna }}
        - name: port-forward-https
          image: alpine/socat:latest
          args:
            - "TCP-LISTEN:443,fork,reuseaddr"
            - "TCP:mock-ena-service:443"
          securityContext:
            runAsUser: 0
          resources:
            requests:
              cpu: 10m
              memory: 16Mi
            limits:
              cpu: 100m
              memory: 32Mi
        - name: port-forward-ftp
          image: alpine/socat:latest
          args:
            - "TCP-LISTEN:21,fork,reuseaddr"
            - "TCP:mock-ena-service:21"
          securityContext:
            runAsUser: 0
          resources:
            requests:
              cpu: 10m
              memory: 16Mi
            limits:
              cpu: 100m
              memory: 32Mi
        {{- end }}
      volumes:
        - name: loculus-ena-submission-config-volume
          configMap:
            name: loculus-ena-submission-config
---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: loculus-get-ena-submission-list-cronjob
spec:
   # run twice a day to ensure at least once no overlap with argo cd refresh
  schedule: "0 1,13 * * *"
  startingDeadlineSeconds: 60
  concurrencyPolicy: Forbid
  jobTemplate:
    spec:
      activeDeadlineSeconds: {{ $.Values.getSubmissionListLimitSeconds }}
      template:
        metadata:
          labels:
            app: loculus
            component: loculus-get-ena-submission-list-cronjob
          annotations:
            argocd.argoproj.io/sync-options: Replace=true
        spec:
          {{- include "possiblePriorityClassName" . | nindent 10 }}
          restartPolicy: Never
          containers:
            - name: ena-submission
              image: "ghcr.io/loculus-project/ena-submission:{{ $dockerTag }}"
              imagePullPolicy: {{ $.Values.imagePullPolicy }}
              {{- include "loculus.resources" (list "ena-submission-list-cronjob" $.Values) | nindent 14 }}
              env:
                - name: EXTERNAL_METADATA_UPDATER_PASSWORD
                  valueFrom:
                    secretKeyRef:
                      name: service-accounts
                      key: externalMetadataUpdaterPassword
                - name: DB_URL
                  valueFrom:
                    secretKeyRef:
                      name: database
                      key: url
                - name: DB_USERNAME
                  valueFrom:
                    secretKeyRef:
                      name: database
                      key: username
                - name: DB_PASSWORD
                  valueFrom:
                    secretKeyRef:
                      name: database
                      key: password
                - name: SLACK_HOOK
                  valueFrom:
                    secretKeyRef:
                      name: slack-notifications
                      key: slack-hook
                - name: SLACK_TOKEN
                  valueFrom:
                    secretKeyRef:
                      name: slack-notifications
                      key: slack-token
                - name: SLACK_CHANNEL_ID
                  valueFrom:
                    secretKeyRef:
                      name: slack-notifications
                      key: slack-channel-id
              args:
                - python
                - "scripts/get_ena_submission_list.py"
                - "--config-file=/config/config.yaml"
              volumeMounts:
                - name: loculus-ena-submission-config-volume
                  mountPath: /config/config.yaml
                  subPath: config.yaml
          volumes:
            - name: loculus-ena-submission-config-volume
              configMap:
                name: loculus-ena-submission-config
{{- end }}
