{{- range $organism, $organismConfig := (.Values.organisms | default .Values.defaultOrganisms) }}
{{- $metadata := $organismConfig.schema.metadata }}
{{- range $processingIndex, $processingConfig := $organismConfig.preprocessing }}
{{- if $processingConfig.configFile }}
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: loculus-preprocessing-config-{{ $organism }}-v{{ $processingConfig.version }}-{{ $processingIndex }}
data:
  preprocessing-config.yaml: |
    {{- $processingConfig.configFile | toYaml | nindent 4 -}}
    processing_spec: 
      {{- include "loculus.preprocessingSpecs" $metadata | nindent 6 }}
{{- end }}
{{- end }}
{{- end }}