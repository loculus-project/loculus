{{- $dockerTag := include "loculus.dockerTag" .Values }}
{{- if not .Values.disableBackend }}
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: loculus-backend
  annotations:
    argocd.argoproj.io/sync-options: Replace=true
spec:
  replicas: {{$.Values.replicas.backend}}
  selector:
    matchLabels:
      app: loculus
      component: backend
  template:
    metadata:
      annotations:
        timestamp: {{ now | quote }}
      labels:
        app: loculus
        component: backend
    spec:
      {{- include "possiblePriorityClassName" . | nindent 6 }}
      initContainers:
{{- include "loculus.configProcessor" (dict "name" "loculus-backend-config" "dockerTag" $dockerTag) | nindent 8 }}
      containers:
        - name: backend
          image: "{{ $.Values.images.backend.repository }}:{{ $.Values.images.backend.tag | default $dockerTag }}"
          imagePullPolicy: "{{ $.Values.images.backend.pullPolicy }}"
          {{- include "loculus.resources" (list "backend" $.Values) | nindent 10 }}
          startupProbe:
            httpGet:
              path: "/actuator/health/liveness"
              port: 8079
            periodSeconds: 5
            failureThreshold: 36 # 3 minutes to start
          livenessProbe:
            httpGet:
              path: "/actuator/health/liveness"
              port: 8079
            periodSeconds: 10
          readinessProbe:
            httpGet:
              path: "/actuator/health/readiness"
              port: 8079
          ports:
            - containerPort: 8079
          env:
            - name: LOCULUS_ENABLE_SEQSETS
              value: {{ $.Values.seqSets.enabled | quote }}
            {{- if $.Values.seqSets.crossRef }}
            - name: CROSSREF_DOI_PREFIX
              value: {{ $.Values.seqSets.crossRef.DOIPrefix | quote }}
            - name: CROSSREF_ENDPOINT
              value: {{ $.Values.seqSets.crossRef.endpoint | quote }}
            - name: CROSSREF_USERNAME
              valueFrom:
               secretKeyRef:
                 name: crossref
                 key: username
            - name: CROSSREF_PASSWORD
              valueFrom:
               secretKeyRef:
                 name: crossref
                 key: password
            - name: CROSSREF_DATABASE_NAME
              value: {{ $.Values.seqSets.crossRef.databaseName | quote }}
            - name: CROSSREF_EMAIL
              value: {{ $.Values.seqSets.crossRef.email | quote }}
            - name: CROSSREF_ORGANIZATION
              value: {{ $.Values.seqSets.crossRef.organization | quote }}
            - name: CROSSREF_HOST_URL
              value: {{ $.Values.seqSets.crossRef.hostUrl | quote }}
           {{- end }}
            - name: KEYCLOAK_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: service-accounts
                  key: backendUserPassword
            - name: KEYCLOAK_REALM
              value: "loculus"
            - name: KEYCLOAK_CLIENT
              value: "backend-client"
            - name: KEYCLOAK_URL
              value: "http://loculus-keycloak-service:8083"
            - name: KEYCLOAK_USER
              value: "backend"
            - name: SPRING_DATASOURCE_PASSWORD
              valueFrom:
               secretKeyRef:
                 name: database
                 key: password
            - name: SPRING_DATASOURCE_URL
              valueFrom:
               secretKeyRef:
                 name: database
                 key: url
            - name: SPRING_DATASOURCE_USERNAME
              valueFrom:
               secretKeyRef:
                 name: database
                 key: username
            - name: SPRING_SECURITY_OAUTH2_RESOURCESERVER_JWT_JWK_SET_URI
              value: "http://loculus-keycloak-service:8083/realms/loculus/protocol/openid-connect/certs"
            - name: LOCULUS_CLEANUP_TASK_RESET_STALE_IN_PROCESSING_AFTER_SECONDS
              value: {{- .Values.preprocessingTimeout | default 120 | quote }}
            - name: LOCULUS_S3_ENABLED
              value: {{ $.Values.s3.enabled | quote }}
            {{- if $.Values.s3.enabled }}
            - name: LOCULUS_S3_BUCKET_ENDPOINT
              value: {{ include "loculus.s3Url" . | quote }}
            - name: LOCULUS_S3_BUCKET_INTERNAL_ENDPOINT
              value: {{ include "loculus.s3UrlInternal" . | quote }}
            - name: LOCULUS_S3_BUCKET_REGION
              value: {{ $.Values.s3.bucket.region | quote }}
            - name: LOCULUS_S3_BUCKET_BUCKET
              value: {{ $.Values.s3.bucket.bucket | quote }}
            - name: LOCULUS_S3_BUCKET_ACCESS_KEY
              valueFrom:
                secretKeyRef:
                  name: s3-bucket
                  key: accessKey
            - name: LOCULUS_S3_BUCKET_SECRET_KEY
              valueFrom:
                secretKeyRef:
                  name: s3-bucket
                  key: secretKey
            {{- end }}
            - name: JVM_OPTS
              value: -XX:+UseContainerSupport -XX:+UseG1GC -XX:MaxHeapFreeRatio=5 -XX:MinHeapFreeRatio=2
          volumeMounts:
            - name: loculus-backend-config-processed
              mountPath: /config
      volumes:
{{ include "loculus.configVolume" (dict "name" "loculus-backend-config") | nindent 8 }}
{{- end }}