{{- $dockerTag := include "loculus.dockerTag" .Values }}
{{- if not .Values.disableBackend }}
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: loculus-backend
  annotations:
    argocd.argoproj.io/sync-options: Replace=true
    reloader.stakater.com/auto: "true"
spec:
  replicas: {{$.Values.replicas.backend}}
  selector:
    matchLabels:
      app: loculus
      component: backend
  template:
    metadata:
      labels:
        app: loculus
        component: backend
    spec:
      {{- include "possiblePriorityClassName" . | nindent 6 }}
      initContainers:
{{- include "loculus.configProcessor" (dict "name" "loculus-backend-config" "dockerTag" $dockerTag) | nindent 8 }}
      containers:
        - name: backend
          image: "ghcr.io/loculus-project/backend:{{ $dockerTag }}"
          imagePullPolicy: Always
          {{- include "loculus.resources" (list "backend" $.Values) | nindent 10 }}
          livenessProbe:
            httpGet:
              path: "/actuator/health/liveness"
              port: 8079
            initialDelaySeconds: 90
            periodSeconds: 10
          readinessProbe:
            httpGet:
              path: "/actuator/health/readiness"
              port: 8079
          ports:
            - containerPort: 8079
          args:
            {{- if .Values.backendExtraArgs }}
              {{- .Values.backendExtraArgs | toYaml | nindent 12 }}
            {{- end }}
          env:
            - name: JVM_OPTS
              value: -XX:+UseContainerSupport -XX:+UseG1GC -XX:MaxHeapFreeRatio=5 -XX:MinHeapFreeRatio=2
          {{- if .Values.enableCrossRefCredentials }}
            - name: CROSSREF_USERNAME
              valueFrom:
                secretKeyRef:
                  name: crossref
                  key: username
            - name: CROSSREF_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: crossref
                  key: password
            - name: CROSSREF_DOI_PREFIX
              value: {{$.Values.crossRef.DOIPrefix | quote }}
            - name: CROSSREF_ENDPOINT
              value: {{$.Values.crossRef.endpoint | quote  }}
            - name: CROSSREF_DATABASE_NAME
              value: {{$.Values.crossRef.databaseName | quote }}
            - name: CROSSREF_EMAIL
              value: {{$.Values.crossRef.email | quote }}
            - name: CROSSREF_ORGANIZATION
              value: {{$.Values.crossRef.organization | quote }}
            - name: CROSSREF_HOST_URL
              value: {{$.Values.crossRef.hostUrl | quote }}
           {{- end }}
            - name: BACKEND_KEYCLOAK_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: service-accounts
                  key: backendUserPassword
            - name: DB_URL
              valueFrom:
                secretKeyRef:
                  name: database
                  key: url
            - name: DB_USERNAME
              valueFrom:
                secretKeyRef:
                  name: database
                  key: username
            - name: DB_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: database
                  key: password
            # Added new environment variables to replace command line args
            - name: CROSSREF_DOI_PREFIX
              value: "$(CROSSREF_DOI_PREFIX)"
            - name: CROSSREF_ENDPOINT
              value: "$(CROSSREF_ENDPOINT)"
            - name: CROSSREF_USERNAME
              value: "$(CROSSREF_USERNAME)"
            - name: CROSSREF_PASSWORD 
              value: "$(CROSSREF_PASSWORD)"
            - name: CROSSREF_DATABASE_NAME
              value: "$(CROSSREF_DATABASE_NAME)"
            - name: CROSSREF_EMAIL
              value: "$(CROSSREF_EMAIL)"
            - name: CROSSREF_ORGANIZATION
              value: "$(CROSSREF_ORGANIZATION)"
            - name: CROSSREF_HOST_URL
              value: "$(CROSSREF_HOST_URL)"
            - name: KEYCLOAK_PASSWORD
              value: "$(BACKEND_KEYCLOAK_PASSWORD)"
            - name: KEYCLOAK_REALM
              value: "loculus"
            - name: KEYCLOAK_CLIENT
              value: "backend-client"
            - name: KEYCLOAK_URL
              value: "http://loculus-keycloak-service:8083"
            - name: KEYCLOAK_USER
              value: "backend"
            - name: SPRING_DATASOURCE_PASSWORD
              value: "$(DB_PASSWORD)"
            - name: SPRING_DATASOURCE_URL
              value: "$(DB_URL)"
            - name: SPRING_DATASOURCE_USERNAME
              value: "$(DB_USERNAME)"
            - name: SPRING_SECURITY_OAUTH2_RESOURCESERVER_JWT_JWK_SET_URI
              value: "http://loculus-keycloak-service:8083/realms/loculus/protocol/openid-connect/certs"
            - name: LOCULUS_CLEANUP_TASK_RESET_STALE_IN_PROCESSING_AFTER_SECONDS
              value: "{{- .Values.preprocessingTimeout | default 120 }}"
          volumeMounts:
            - name: loculus-backend-config-processed
              mountPath: /config
      volumes:
{{ include "loculus.configVolume" (dict "name" "loculus-backend-config") | nindent 8 }}
{{- end }}
