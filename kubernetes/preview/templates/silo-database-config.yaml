{{- $configFile := .Files.Get "config.yml" | fromYaml }}
{{- $commonMetadata := (include "pathoplexus.commonMetadata" . | fromYaml).fields }}
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: silo-database-config
  namespace: {{ .Values.namespace }}
data:
  database_config.yaml: |
    schema:
      instanceName: {{ $configFile.schema.instanceName }}
      opennessLevel: OPEN
      metadata:
      {{- range (concat $commonMetadata $configFile.schema.metadata) }}
        - name: {{ .name }}
          type: {{ .type }}
          {{- if .generateIndex }}
          generateIndex: {{ .generateIndex }}
          {{- end }}
      {{- end }}
      primaryKey: sequenceVersion
    {{- $configFile.schema.silo | toYaml | nindent 6 }}

  preprocessing_config_yaml: |-
    metadataFilename: metadata.tsv
    pangoLineageDefinitionFilename: pangolineage_alias.json
    referenceGenomeFilename: reference_genomes.json

  reference_genomes.json: |-
    {{ .Files.Get "reference_genomes.json" | fromJson | toJson }}
