{{- $lapisHost := printf "lapis.%s" .Values.host }}
{{- $mode := .Values.mode }}
{{- $configFile := .Files.Get "config.yml" | fromYaml }}
{{- $namespace := .Values.namespace }}
{{- range $key, $_ := $configFile.instances }}

---
apiVersion: traefik.containo.us/v1alpha1
kind: IngressRoute
metadata:
  name: lapis-ingressroute-{{ $key }}
  namespace: {{ $namespace }}
  annotations:
    cert-manager.io/cluster-issuer: "letsencrypt-prod"
{{- if eq $mode "cd" }}
    link.argocd.argoproj.io/external-link: https://{{ $lapisHost }}
{{- end }}
spec:
  entryPoints:
    {{- if eq $mode "cd" }}
    - websecure
    {{- else }}
    - web
    {{- end }}
  routes:
  - match: Path(`/{{ $key }}`, `/{{ $key }}/{path:.*}`) {{- if eq $mode "cd" }} && Host(`{{ $lapisHost }}`){{- end }}
    kind: Rule
    services:
    - name: pathoplexus-lapis-service-{{ $key }}
      port: 8080
    middlewares:
    - name: strip-{{ $key }}-prefix
{{- if eq $mode "cd" }}
  tls:
    certResolver: myresolver
{{- end }}

---
apiVersion: traefik.containo.us/v1alpha1
kind: Middleware
metadata:
  name: strip-{{ $key }}-prefix
  namespace: {{ $namespace }}
spec:
  stripPrefix:
    prefixes:
      - /{{ $key }}
{{- end }}
