{{- if eq .Values.mode "cd" }}
{{- $backendHost := printf "backend.%s" .Values.host }}
{{- $lapisHost := printf "lapis.%s" .Values.host }}
{{- $configFile := .Files.Get "config.yml" | fromYaml }}

apiVersion: traefik.containo.us/v1alpha1
kind: IngressRoute
metadata:
  creationTimestamp: '2023-10-24T13:00:51Z'
  name: pathoplexus-website-ingressroute
  namespace: {{ .Values.namespace }}
  annotations:
    cert-manager.io/cluster-issuer: "letsencrypt-prod"
    link.argocd.argoproj.io/external-link: https://{{ .Values.host }}
spec:
  entryPoints:
    - websecure
  routes:
    - kind: Rule
      match: Host(`{{ .Values.host }}`)
      priority: 10
      services:
        - name: pathoplexus-website-service
          port: 3000
  tls:
    certResolver: myresolver
---
apiVersion: traefik.containo.us/v1alpha1
kind: IngressRoute
metadata:
  creationTimestamp: '2023-10-24T13:00:51Z'
  name: pathoplexus-backend-ingressroute
  namespace: {{ .Values.namespace }}
  annotations:
    cert-manager.io/cluster-issuer: "letsencrypt-prod"
    link.argocd.argoproj.io/external-link: https://{{ $backendHost }}
spec:
  entryPoints:
    - websecure
  routes:
    - kind: Rule
      match: Host(`{{ $backendHost }}`)
      priority: 10
      services:
        - name: pathoplexus-backend-service
          port: 8079
  tls:
    certResolver: myresolver
---
apiVersion: traefik.containo.us/v1alpha1
kind: IngressRoute
metadata:
  name: pathoplexus-lapis-ingressroute
  namespace: {{ .Values.namespace }}
  annotations:
    cert-manager.io/cluster-issuer: "letsencrypt-prod"
    link.argocd.argoproj.io/external-link: https://{{ $lapisHost }}
spec:
  entryPoints:
    - websecure
  routes:
    {{- range $key, $_ := $configFile.instances }}
    - kind: Rule
      match: "Host(`{{ $lapisHost }}`) && PathPrefix(`/{{ $key }}`)"
      priority: 10
      services:
        - name: pathoplexus-lapis-service-{{ $key }}
          port: 8080
    {{- end }}
  tls:
    certResolver: myresolver
{{- end }}
