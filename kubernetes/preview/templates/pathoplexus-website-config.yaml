{{- $keycloakHost := printf "authentication.%s" .Values.host }}
{{- $config := .Files.Get "config.yaml" | fromYaml }}
{{- $lapisHost := (
  eq .Values.environment "server" | ternary
    (printf "https://lapis.%s" .Values.host)
    "http://localhost:8080"
) }}
{{- $externalLapisUrlConfig := dict
  "host" $lapisHost
  "config" $config
}}

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: pathoplexus-website-config
  namespace: {{ .Values.namespace }}
data:
  website_config.json: |
    {{ .Files.Get "config.yaml" | fromYaml | include "pathoplexus.generateWebsiteConfig" | fromYaml | toJson }}

  runtime_config.json: |
    {
        "serverSide": {
            {{- if .Values.disableBackend }}
            "backendUrl": "http://host.k3d.internal:8079",
            {{- else }}
            "backendUrl": "http://localhost:8079",
            {{- end }}
            "lapisUrls": {{- include "pathoplexus.generateInternalLapisUrls" $config | fromYaml | toJson }},
            "keycloakUrl": "http://pathoplexus-keycloak-service:8083"
        },
        "public": {
            {{- if eq .Values.environment "server" }}
            "backendUrl": "https://{{ printf "backend.%s" .Values.host }}",
             {{- else }}
            "backendUrl": "http://localhost:8079",
              {{- end }}
            "lapisUrls": {{- include "pathoplexus.generateExternalLapisUrls" $externalLapisUrlConfig | fromYaml | toJson }}
        }
    }
