The `backend`, `website`, and `integration-tests` directories each contain their own `AGENTS.md` files with additional specific instructions.

Use conventional commits as titles for PRs, e.g. feat(deployment):xx, fix!(website):xx, chore(backend):xx.
Components include: website, backend, deployment, preprocessing, ingest, deposition.

Write detailed PR summaries, not just short bullet points.

## Preventing flaky Playwright tests (website)

When adding or modifying interactive components in the website, ensure they are disabled until React hydration completes to prevent race conditions in Playwright tests:

- **For buttons**: Use `Button` from `src/components/common/Button.tsx` instead of native `<button>`
- **For Headless UI Combobox**: Import from `src/components/common/headlessui/Combobox.tsx` instead of `@headlessui/react`
- **For other interactive elements**: Wrap with `DisabledUntilHydrated` or use the `useClientFlag` hook

These wrappers automatically disable components until client-side hydration is complete, preventing Playwright from interacting with them before they're ready.

## Running Integration Tests Locally (k3d)

See `integration-tests/AGENTS.md` for full instructions. Key gotchas:

### Anaconda Python conflict
If Anaconda is in your PATH, `deploy.py` will fail with "Python 3.9 or higher is required". Use `/usr/bin/python3 ./deploy.py` instead.

### Disk pressure (k3d nodes won't schedule pods)
k3d nodes inherit the host's disk. If disk usage is above ~85%, kubelet marks nodes with `DiskPressure` taint and pods stay `Pending`. Free up disk space or create the cluster with relaxed eviction thresholds:
```sh
k3d cluster create testCluster ... \
  --k3s-arg '--kubelet-arg=eviction-hard=imagefs.available<1%,nodefs.available<1%@server:*' \
  --k3s-arg '--kubelet-arg=eviction-hard=imagefs.available<1%,nodefs.available<1%@agent:*'
```

### Critical: Fix `host.k3d.internal` DNS for pods (S3/MinIO connectivity)
After deploying with `localHost: host.k3d.internal`, pods **cannot** reach `host.k3d.internal:8084` (MinIO/S3) because that hostname resolves to the Docker gateway IP which doesn't forward host ports. Pre-signed S3 URLs generated by the backend contain `host.k3d.internal:8084` and are used by preprocessing pods, causing `ConnectionError` / `ConnectTimeoutError`.

**Fix**: Override CoreDNS to point `host.k3d.internal` to the MinIO service ClusterIP:
```sh
MINIO_IP=$(kubectl get svc loculus-minio-service -o jsonpath='{.spec.clusterIP}')
kubectl patch configmap coredns -n kube-system --type=json \
  -p="[{\"op\":\"replace\",\"path\":\"/data/NodeHosts\",\"value\":\"${MINIO_IP} host.k3d.internal\n$(kubectl get configmap coredns -n kube-system -o jsonpath='{.data.NodeHosts}' | grep -v host.k3d.internal)\"}]"
kubectl rollout restart deployment coredns -n kube-system
# Restart preprocessing pods to pick up DNS change
kubectl get deployments | grep preprocessing | awk '{print $1}' | xargs -I {} kubectl rollout restart deployment {}
```

### CLI tests require `keyrings.alt`
Install it in the CLI venv, not system-wide: `uv pip install --python cli/.venv/bin/python keyrings.alt`

### CLI must be on PATH
The integration tests invoke `loculus` directly. Symlink it: `ln -sf $(pwd)/cli/.venv/bin/loculus ~/bin/loculus`

## Updating Conda Environment Dependencies

Conda dependencies in `environment.yml` files are not automatically updated by dependabot.
The `maintenance-scripts/` folder contains utilities to help update conda environment versions.
