name: Mirror Images to GHCR

on:
  schedule:
    - cron: '0 3 * * *'  # Daily at 3 AM UTC
  workflow_dispatch:
    inputs:
      force_mirror:
        description: 'Force mirror all images'
        type: boolean
        default: false

permissions:
  packages: write
  contents: read

jobs:
  mirror:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Log in to Docker Hub (if secrets available)
        if: ${{ secrets.DOCKERHUB_USERNAME != '' }}
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN_READ_PUBLIC }}

      - name: Mirror images
        env:
          FORCE: ${{ inputs.force_mirror || 'false' }}
        run: |
          set -euo pipefail
          
          # Install yq for YAML parsing
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq
          
          images=$(yq eval '.images | length' .github/docker-image-mirror-config.yaml)
          
          for i in $(seq 0 $((images - 1))); do
            source=$(yq eval ".images[$i].source" .github/docker-image-mirror-config.yaml)
            dest=$(yq eval ".images[$i].destination" .github/docker-image-mirror-config.yaml)
            
            echo "Mirroring: $source → $dest"
            
            # Skip if exists (unless forced)
            if [ "$FORCE" != "true" ] && docker manifest inspect "$dest" > /dev/null 2>&1; then
              echo "  ✓ Already exists, skipping"
              continue
            fi
            
            docker pull "$source"
            docker tag "$source" "$dest"
            docker push "$dest"
            echo "  ✓ Mirrored successfully"
          done
          
          echo "✓ All images mirrored"
