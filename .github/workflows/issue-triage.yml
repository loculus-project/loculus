name: Issue and PR Triage

on:
  issues:
    types: [opened]
  pull_request:
    types: [opened]

jobs:
  triage-issue:
    if: github.event_name == 'issues'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: read
      issues: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create issue triage prompt
        run: |
          mkdir -p /tmp/claude-prompts
          cat > /tmp/claude-prompts/triage-prompt.txt << 'EOF'
          You're an issue triage assistant for the Loculus project. Your tasks are to:
          1. Analyze the issue and apply appropriate component labels
          2. Search for duplicate issues and comment if found

          Issue Information:
          - REPO: ${{ github.repository }}
          - ISSUE_NUMBER: ${{ github.event.issue.number }}

          COMPONENT LABELS TO USE:
          The following labels should be applied based on which component(s) the issue relates to:
          - `website` - Issues related to the web frontend (website/ directory)
          - `backend` - Issues related to the backend API/server (backend/ directory)
          - `deposition` - Issues related to ENA submission/deposition (ena-submission/ directory)
          - `preprocessing` - Issues related to data preprocessing (preprocessing/ directory)
          - `deployment` - Issues related to Kubernetes deployment/infrastructure (kubernetes/ directory)
          - `ingest` - Issues related to data ingestion (ingest/ directory)

          TASK STEPS:

          1. First, fetch the list of available labels in this repository:
             Run: `gh label list`

          2. Get context about the issue:
             - Use mcp__github__get_issue to retrieve the issue's title, description, and existing labels
             - Use mcp__github__get_issue_comments if there are comments that might provide additional context

          3. Analyze the issue content to determine:
             - Which component(s) are affected based on:
               - Explicit mentions of components (website, backend, API, frontend, etc.)
               - File paths or directories mentioned
               - Feature areas described (UI issues -> website, API issues -> backend, etc.)
               - Error messages or stack traces that indicate the component
             - The type of issue (bug, feature request, question, etc.)

          4. Search for potential duplicate issues:
             - Use mcp__github__search_issues to find similar issues by searching for key terms from the title and description
             - Look for issues with similar error messages, feature requests, or problem descriptions
             - Focus on OPEN issues when identifying duplicates

          5. Apply component labels:
             - Use mcp__github__update_issue to apply the appropriate component labels
             - You can apply multiple component labels if the issue spans multiple components
             - If no component is clearly identifiable, do not apply component labels

          6. If potential duplicates are found:
             - Use `gh issue comment` to post a helpful comment like:
               "This issue may be related to existing issues: #X, #Y. Please check if your issue is already being tracked."
             - Only comment if you find genuinely similar issues (not just any issue with a common word)
             - Include issue numbers as links

          IMPORTANT GUIDELINES:
          - Be thorough in your analysis
          - Only apply labels that exist in the repository
          - When in doubt about duplicates, err on the side of not commenting
          - Keep duplicate comments brief and helpful
          EOF

      - name: Setup GitHub MCP Server
        run: |
          mkdir -p /tmp/mcp-config
          cat > /tmp/mcp-config/mcp-servers.json << 'EOF'
          {
            "mcpServers": {
              "github": {
                "command": "docker",
                "args": [
                  "run",
                  "-i",
                  "--rm",
                  "-e",
                  "GITHUB_PERSONAL_ACCESS_TOKEN",
                  "ghcr.io/github/github-mcp-server:sha-7aced2b"
                ],
                "env": {
                  "GITHUB_PERSONAL_ACCESS_TOKEN": "${{ secrets.GITHUB_TOKEN }}"
                }
              }
            }
          }
          EOF

      - name: Run Claude Code for Issue Triage
        timeout-minutes: 5
        uses: anthropics/claude-code-base-action@v1
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          prompt_file: /tmp/claude-prompts/triage-prompt.txt
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          claude_args: |
            --model claude-sonnet-4-5-20250929
            --mcp-config /tmp/mcp-config/mcp-servers.json
            --allowedTools "Bash(gh label list),Bash(gh issue comment:*),mcp__github__get_issue,mcp__github__get_issue_comments,mcp__github__update_issue,mcp__github__search_issues,mcp__github__list_issues"

  label-pr:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: read
      pull-requests: write
      issues: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Create PR labeling prompt
        run: |
          mkdir -p /tmp/claude-prompts
          cat > /tmp/claude-prompts/pr-label-prompt.txt << 'EOF'
          You're a PR triage assistant for the Loculus project. Your tasks are to:
          1. Analyze the changed files and apply appropriate component labels
          2. Search for duplicate or related issues/PRs and comment if found

          PR Information:
          - REPO: ${{ github.repository }}
          - PR_NUMBER: ${{ github.event.pull_request.number }}
          - PR_TITLE: ${{ github.event.pull_request.title }}

          COMPONENT LABEL MAPPING:
          Apply labels based on which directories have changed files:
          - `website` - Changes in website/ directory
          - `backend` - Changes in backend/ directory
          - `deposition` - Changes in ena-submission/ directory
          - `preprocessing` - Changes in preprocessing/ directory
          - `deployment` - Changes in kubernetes/ directory
          - `ingest` - Changes in ingest/ directory

          TASK STEPS:

          1. Get the list of changed files in this PR:
             Run: `gh pr diff ${{ github.event.pull_request.number }} --name-only`

          2. Fetch the list of available labels:
             Run: `gh label list`

          3. Analyze changed files and determine component labels:
             - website/* -> apply "website" label
             - backend/* -> apply "backend" label
             - ena-submission/* -> apply "deposition" label
             - preprocessing/* -> apply "preprocessing" label
             - kubernetes/* -> apply "deployment" label
             - ingest/* -> apply "ingest" label
             - Multiple directories -> apply multiple labels

          4. Apply the component labels:
             Run: `gh pr edit ${{ github.event.pull_request.number }} --add-label "label1,label2"`
             Only add labels that exist in the repository.

          5. Search for related issues that this PR might address:
             - Use mcp__github__search_issues to find issues with similar keywords
             - Look for issues that describe the bug being fixed or feature being added
             - Check the PR title and description for issue references

          6. If related issues are found that aren't already linked:
             - Use `gh pr comment` to post a helpful comment like:
               "This PR may be related to: #X, #Y"
             - Only comment if genuinely related issues are found
             - Skip if issues are already linked in the PR description

          IMPORTANT GUIDELINES:
          - Always apply component labels based on changed files
          - Only apply labels that exist in the repository
          - Be conservative when suggesting related issues
          - Do not duplicate information already in the PR description
          EOF

      - name: Setup GitHub MCP Server
        run: |
          mkdir -p /tmp/mcp-config
          cat > /tmp/mcp-config/mcp-servers.json << 'EOF'
          {
            "mcpServers": {
              "github": {
                "command": "docker",
                "args": [
                  "run",
                  "-i",
                  "--rm",
                  "-e",
                  "GITHUB_PERSONAL_ACCESS_TOKEN",
                  "ghcr.io/github/github-mcp-server:sha-7aced2b"
                ],
                "env": {
                  "GITHUB_PERSONAL_ACCESS_TOKEN": "${{ secrets.GITHUB_TOKEN }}"
                }
              }
            }
          }
          EOF

      - name: Run Claude Code for PR Labeling
        timeout-minutes: 5
        uses: anthropics/claude-code-base-action@v1
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          prompt_file: /tmp/claude-prompts/pr-label-prompt.txt
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          claude_args: |
            --model claude-sonnet-4-5-20250929
            --mcp-config /tmp/mcp-config/mcp-servers.json
            --allowedTools "Bash(gh pr diff:*),Bash(gh pr edit:*),Bash(gh pr comment:*),Bash(gh label list),mcp__github__search_issues,mcp__github__list_issues,mcp__github__get_issue"
