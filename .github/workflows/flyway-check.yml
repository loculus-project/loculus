name: Flyway Migration Check

on:
  pull_request:
    branches: [ main ]
    paths:
      - 'backend/src/main/resources/db/migration/**'

jobs:
  check-migrations:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
      with:
        fetch-depth: 0

    - name: Set up JDK 11
      uses: actions/setup-java@v3
      with:
        java-version: '11'
        distribution: 'adopt'

    - name: Install Flyway CLI
      run: |
        wget -qO- https://repo1.maven.org/maven2/org/flywaydb/flyway-commandline/8.5.13/flyway-commandline-8.5.13-linux-x64.tar.gz | tar xvz
        sudo ln -s `pwd`/flyway-8.5.13/flyway /usr/local/bin

    - name: Check for modified migrations
      run: |
        git fetch origin main:main
        modified_files=$(git diff --name-only main...HEAD -- src/main/resources/db/migration/)
        new_files=$(git diff --name-only --diff-filter=A main...HEAD -- src/main/resources/db/migration/)
        
        if [ -n "$modified_files" ]; then
          echo "The following existing migration files have been modified:"
          echo "$modified_files"
          echo "Error: Modifying existing migrations is not allowed."
          exit 1
        fi
        
        if [ -n "$new_files" ]; then
          echo "The following new migration files have been added:"
          echo "$new_files"
          echo "New migrations are allowed."
        fi
        
        if [ -z "$modified_files" ] && [ -z "$new_files" ]; then
          echo "No changes to migration files detected."
        fi


    - name: Validate new migrations
      run: flyway validate -locations=filesystem:backend/src/main/resources/db/migration

    - name: Run Flyway info
      run: flyway info -locations=filesystem:backend/src/main/resources/db/migration
