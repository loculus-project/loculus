name: Generate and Validate Helm Template Output

on:
  pull_request:
    types: [opened, synchronize, labeled]
    paths:
      - 'kubernetes/loculus/**'
      - '.github/workflows/helm-template-output.yml'
  workflow_dispatch:

jobs:
  generate-helm-output:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        config:
          - name: default
            values_files: kubernetes/loculus/values.yaml
          - name: e2e-dev
            values_files: kubernetes/loculus/values.yaml --values kubernetes/loculus/values_e2e_and_dev.yaml
          - name: preview-server
            values_files: kubernetes/loculus/values.yaml --values kubernetes/loculus/values_preview_server.yaml

    steps:
    - name: Checkout repository
      uses: actions/checkout@v5
      with:
        ref: ${{ github.head_ref }}
        fetch-depth: 0

    - name: Install Helm
      uses: azure/setup-helm@v4
      with:
        version: 'v3.14.0'

    - name: Create output directory
      run: mkdir -p kubernetes/loculus/docs/rendered/${{ matrix.config.name }}

    - name: Generate and split helm template output for ${{ matrix.config.name }}
      run: |
        helm template loculus kubernetes/loculus \
          --values ${{ matrix.config.values_files }} \
          > /tmp/helm-output-${{ matrix.config.name }}.yaml
        sed -i 's/timestamp: "[^"]*"/timestamp: ""/g' /tmp/helm-output-${{ matrix.config.name }}.yaml
        .github/scripts/split-helm-output.sh /tmp/helm-output-${{ matrix.config.name }}.yaml kubernetes/loculus/docs/rendered/${{ matrix.config.name }}

    - name: Upload rendered output as artifact
      uses: actions/upload-artifact@v4
      with:
        name: helm-output-${{ matrix.config.name }}
        path: kubernetes/loculus/docs/rendered/${{ matrix.config.name }}
        retention-days: 1

  commit-changes:
    runs-on: ubuntu-latest
    needs: generate-helm-output

    # Explicitly set permissions needed for committing
    permissions:
      contents: write
      pull-requests: read

    steps:
    - name: Checkout repository
      uses: actions/checkout@v5
      with:
        ref: ${{ github.head_ref }}
        fetch-depth: 0

    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: /tmp/helm-artifacts/

    - name: Reorganize artifacts
      run: |
        # Clear any existing rendered output
        rm -rf kubernetes/loculus/docs/rendered/default kubernetes/loculus/docs/rendered/e2e-dev kubernetes/loculus/docs/rendered/preview-server

        # Move artifacts to the correct location
        # Artifacts are downloaded as: /tmp/helm-artifacts/helm-output-{name}/*
        for config in default e2e-dev preview-server; do
          if [ -d "/tmp/helm-artifacts/helm-output-$config" ]; then
            mkdir -p kubernetes/loculus/docs/rendered/$config
            mv /tmp/helm-artifacts/helm-output-$config/* kubernetes/loculus/docs/rendered/$config/
          fi
        done

    - name: Show generated output structure
      run: |
        echo "=== Generated files structure ==="
        tree -L 2 kubernetes/loculus/docs/rendered/ || find kubernetes/loculus/docs/rendered/ -type f | head -20
        echo ""
        echo "=== Sample: default/loculus-backend.yaml (first 30 lines) ==="
        head -n 30 kubernetes/loculus/docs/rendered/default/loculus-backend.yaml || echo "File not found"

    - name: Stage rendered output files
      run: git add kubernetes/loculus/docs/rendered/

    - name: Check for output changes
      id: check-changes
      run: |
        if ! git diff --cached --quiet kubernetes/loculus/docs/rendered/; then
          echo "Helm template output changes detected"
          echo "changed=true" >> $GITHUB_OUTPUT
          git diff --cached --stat kubernetes/loculus/docs/rendered/
        else
          echo "No helm template output changes detected"
          echo "changed=false" >> $GITHUB_OUTPUT
        fi

    - name: Handle output changes
      if: steps.check-changes.outputs.changed == 'true'
      run: |
        if [[ "${{ contains(github.event.pull_request.labels.*.name, 'update_helm_output') }}" == "true" ]]; then
          git config --global user.name 'GitHub Action'
          git config --global user.email 'action@github.com'
          git commit -m "Update helm template output documentation"
          git push
        else
          echo "::error::Helm template output changes detected but 'update_helm_output' label is not present on the PR"
          echo "Please add the 'update_helm_output' label if these changes are intentional"
          exit 1
        fi
