---
import { SequenceEntryTable } from './SequenceEntryTable';
import { SequenceStatusBox } from './SequenceStatusBox';
import { getRuntimeConfig } from '../../config';
import type { SequenceEntryStatus } from '../../types/backend';

interface Props {
    sequenceEntries: SequenceEntryStatus[];
    username: string;
}

const organism = Astro.params.organism!;

const { sequenceEntries, username } = Astro.props;
const clientConfig = getRuntimeConfig().public;

const statusArray = sequenceEntries.reduce(
    (acc, item) => {
        acc[item.status].push(item);
        return acc;
    },
    {
        RECEIVED: [] as SequenceEntryStatus[],
        IN_PROCESSING: [] as SequenceEntryStatus[],
        HAS_ERRORS: [] as SequenceEntryStatus[],
        AWAITING_APPROVAL: [] as SequenceEntryStatus[],
        APPROVED_FOR_RELEASE: [] as SequenceEntryStatus[],
        AWAITING_APPROVAL_FOR_REVOCATION: [] as SequenceEntryStatus[],
    },
);

const keyPrefix = `userSequences.${username}`;
---

<div class='flex flex-col gap-2 mt-5'>
    <SequenceStatusBox
        count={statusArray.RECEIVED.length}
        description='received'
        localStorageKey={`${keyPrefix}.receivedExpanded`}
        client:only='react'
    >
        <SequenceEntryTable
            organism={organism}
            username={username}
            sequenceEntries={statusArray.RECEIVED}
            bulkActionNames={['delete']}
            singleActionNames={[]}
            clientConfig={clientConfig}
            client:load
        />
    </SequenceStatusBox>

    <SequenceStatusBox
        count={statusArray.IN_PROCESSING.length}
        description='in processing'
        localStorageKey={`${keyPrefix}.processingExpanded`}
        client:only='react'
    >
        <SequenceEntryTable
            organism={organism}
            username={username}
            sequenceEntries={statusArray.IN_PROCESSING}
            bulkActionNames={[]}
            singleActionNames={[]}
            clientConfig={clientConfig}
            client:load
        />
    </SequenceStatusBox>

    <SequenceStatusBox
        count={statusArray.HAS_ERRORS.length}
        description={`need${statusArray.HAS_ERRORS.length === 1 ? 's' : ''} review`}
        localStorageKey={`${keyPrefix}.needsReviewExpanded`}
        client:only='react'
    >
        <SequenceEntryTable
            organism={organism}
            username={username}
            sequenceEntries={statusArray.HAS_ERRORS}
            bulkActionNames={['delete']}
            singleActionNames={['review']}
            clientConfig={clientConfig}
            client:load
        />
    </SequenceStatusBox>

    <SequenceStatusBox
        count={statusArray.AWAITING_APPROVAL.length}
        description='processed'
        localStorageKey={`${keyPrefix}.stagingExpanded`}
        client:only='react'
    >
        <SequenceEntryTable
            organism={organism}
            username={username}
            sequenceEntries={statusArray.AWAITING_APPROVAL}
            bulkActionNames={['approve', 'delete']}
            singleActionNames={['review']}
            clientConfig={clientConfig}
            client:load
        />
    </SequenceStatusBox>

    <SequenceStatusBox
        count={statusArray.APPROVED_FOR_RELEASE.length}
        description='ready for SILO import'
        localStorageKey={`${keyPrefix}.readyExpanded`}
        client:only='react'
    >
        <SequenceEntryTable
            organism={organism}
            username={username}
            sequenceEntries={statusArray.APPROVED_FOR_RELEASE}
            bulkActionNames={['revoke']}
            singleActionNames={[]}
            clientConfig={clientConfig}
            client:load
        />
    </SequenceStatusBox>

    <SequenceStatusBox
        count={statusArray.AWAITING_APPROVAL_FOR_REVOCATION.length}
        description='staged for revocation'
        localStorageKey={`${keyPrefix}.revokedExpanded`}
        client:only='react'
    >
        <SequenceEntryTable
            organism={organism}
            username={username}
            sequenceEntries={statusArray.AWAITING_APPROVAL_FOR_REVOCATION}
            bulkActionNames={['confirmRevocation', 'delete']}
            singleActionNames={[]}
            clientConfig={clientConfig}
            client:load
        />
    </SequenceStatusBox>
</div>
