---
import { SequenceEntryHistoryMenu } from './SequenceEntryHistoryMenu';
import { getWebsiteConfig } from '../../config';
import { routes } from '../../routes/routes';
import { type SequenceEntryHistory } from '../../types/lapis';
import IcBaselineDownload from '~icons/ic/baseline-download';
import IwwaArrowDown from '~icons/iwwa/arrow-down';
import MaterialSymbolsReportOutlineRounded from '~icons/material-symbols/report-outline-rounded';

interface Props {
    sequenceEntryHistory?: SequenceEntryHistory;
    organism: string;
    accessionVersion: string;
    showDownload: boolean;
}

const { sequenceEntryHistory, organism, accessionVersion, showDownload } = Astro.props;
let showFlagging = true; // TODO expose this parameter; revoked seqs shouldn't be flaggable
const reportUrl: string | undefined = undefined;

const config = getWebsiteConfig();
if (showFlagging && config.sequenceFlagging !== undefined) {
    const ghConf = config.sequenceFlagging.github;
    const url = new URL(`/${ghConf.organization}/${ghConf.repo}/issues/new`, 'https://github.com');
    if (ghConf.issueTemplate) {
        url.searchParams.append('template', ghConf.issueTemplate);
    }
    url.searchParams.append('title', `[${organism} - ${accessionVersion}]`);
} else {
    showFlagging = false;
}

// TODO make URL configurable
---

<div class='flex justify-between flex-wrap'>
    <div class='flex flex-row pb-6'>
        <h1 class='title'>{accessionVersion}</h1>
    </div>

    <div class='pt-2 space-x-2'>
        {
            sequenceEntryHistory !== undefined && sequenceEntryHistory.length > 1 && (
                <SequenceEntryHistoryMenu
                    sequenceEntryHistory={sequenceEntryHistory}
                    accessionVersion={accessionVersion}
                />
            )
        }
        {
            reportUrl !== undefined && (
                <div class='inline-block dropdown dropdown-hover dropdown-end relative group'>
                    <a tabindex='0' class='text-primary-700 cursor-pointer' href={reportUrl} target='_blank'>
                        <span class='hidden sm:block py-1'>Report</span>
                        <span tabindex='0' class='sm:hidden inline text-xl'>
                            <MaterialSymbolsReportOutlineRounded />
                        </span>
                    </a>
                    <div class='absolute left-1/2 transform -translate-x-1/2 top-full mt-2 opacity-0 group-hover:opacity-100 transition-opacity bg-gray-800 text-white text-sm px-2 py-1 rounded w-48'>
                        Make a curation report if you suspect that there is an error in the data or something has been
                        mislabeled.
                    </div>
                </div>
            )
        }
        {
            showDownload && (
                <div class='inline-block dropdown dropdown-hover dropdown-end'>
                    <label tabindex='0' class='hidden sm:block py-1 text-primary-700 cursor-pointer'>
                        Download
                        <span class='text-primary'>
                            {' '}
                            <IwwaArrowDown className='inline-block -mt-1 ml-1 h-4 w-4' />
                        </span>
                    </label>
                    <span tabindex='0' class='sm:hidden inline text-xl cursor-pointer text-primary-700'>
                        <IcBaselineDownload />
                    </span>
                    <ul class='dropdown-content z-20 menu p-1 shadow bg-base-100 rounded-btn top-full -left-44 sm:-left-24 w-52'>
                        <li>
                            <a
                                href={routes.sequenceEntryFastaPage(accessionVersion, true)}
                                class='block px-4 py-2 outlineButtonDropdownItem'
                            >
                                Download FASTA
                            </a>
                        </li>
                        <li>
                            <a
                                href={routes.sequenceEntryTsvPage(accessionVersion, true)}
                                class='block px-4 py-2 outlineButtonDropdownItem'
                            >
                                Download metadata TSV
                            </a>
                        </li>
                    </ul>
                </div>
            )
        }
    </div>
</div>
