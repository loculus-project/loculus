---
import { GroupManager } from './GroupManager';
import { getRuntimeConfig } from '../../config';
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getKeycloakClient } from '../../middleware/authMiddleware';
import { routes } from '../../routes';
import { getAccessToken } from '../../utils/getAccessToken';
import { BackButton } from '../Navigation/BackButton';

const session = Astro.locals.session;

const accessToken = getAccessToken(Astro.locals.session)!;

const clientConfig = getRuntimeConfig().public;

const organism: string | undefined = Astro.params.organism;

const logoutUrl = new URL(Astro.request.url);
logoutUrl.pathname = routes.logout();

const keycloakLogoutUrl = (await getKeycloakClient()).endSessionUrl({
    post_logout_redirect_uri: logoutUrl.href,
});
---

<BaseLayout title='Login'>
    <div class='flex items-center'>
        <BackButton marginRight={2} client:load />
        <h1 class='title'>User {session.user?.name}</h1>
    </div>
    <div class='my-2 mx-4'>
        <a href={keycloakLogoutUrl}>Logout</a>
    </div>
    {
        organism !== undefined && (
            <div class='my-2 mx-4'>
                <a href={routes.userSequencesPage(organism)}>Sequence Overview</a>
            </div>
        )
    }
    {
        session.user?.username !== undefined && (
            <div class='my-2 mx-4'>
                <a href={routes.datasetsPage(session.user?.username)}>Datasets Overview</a>
            </div>
        )
    }
    {
        session.user?.username !== undefined && (
            <GroupManager
                accessToken={accessToken}
                clientConfig={clientConfig}
                username={session.user.username}
                client:load
            />
        )
    }
</BaseLayout>
