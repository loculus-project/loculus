---
import { GroupPage } from '../../../components/User/GroupPage';
import ErrorBox from '../../../components/common/ErrorBox.tsx';
import { getConfiguredOrganisms, getRuntimeConfig, getWebsiteConfig } from '../../../config';
import BaseLayout from '../../../layouts/BaseLayout.astro';
import type { ContinueSubmissionIntent } from '../../../routes/routes';
import { GroupManagementClient } from '../../../services/groupManagementClient';
import { getAccessToken } from '../../../utils/getAccessToken';
import { getAuthUrl } from '../../../utils/getAuthUrl';

const session = Astro.locals.session;
const accessToken = getAccessToken(session);
const username = session?.user?.username ?? '';
const groupId = parseInt(Astro.params.groupId!, 10);
const clientConfig = getRuntimeConfig().public;
const organisms = getConfiguredOrganisms();
const websiteConfig = getWebsiteConfig();
const databaseName = websiteConfig.name;
const metadataItemForCumulativeGroupGraph = websiteConfig.metadataItemForCumulativeGroupGraph;
const loginUrl = await getAuthUrl(Astro.url.toString());

const continueSubmissionOrganism = Astro.url.searchParams.get('continueSubmissionOrganism');

const continueSubmissionIntent: ContinueSubmissionIntent | undefined =
    continueSubmissionOrganism !== null ? { organism: continueSubmissionOrganism } : undefined;

if (isNaN(groupId)) {
    return new Response(undefined, {
        status: 404,
    });
}

const groupManagementClient = GroupManagementClient.create();
const groupDetailsResult = await groupManagementClient.getGroupDetails(groupId, accessToken);
const userGroupsResponse = await groupManagementClient.getGroupsOfUser(accessToken);
const userGroups = userGroupsResponse.match(
    (groups) => groups,
    () => [],
);
---

<BaseLayout
    title={groupDetailsResult.match(
        (groupDetails) => groupDetails.group.groupName,
        () => 'Group error',
    )}
    activeTopNavigationItem='account'
>
    {
        groupDetailsResult.match(
            (groupDetails) => (
                <GroupPage
                    prefetchedGroupDetails={groupDetails}
                    accessToken={accessToken}
                    clientConfig={clientConfig}
                    username={username}
                    userGroups={userGroups}
                    organisms={organisms}
                    databaseName={databaseName}
                    continueSubmissionIntent={continueSubmissionIntent}
                    loginUrl={loginUrl}
                    metadataItemForCumulativeGroupGraph={metadataItemForCumulativeGroupGraph}
                    client:load
                />
            ),
            () => <ErrorBox>Failed to fetch group details, sorry for the inconvenience!</ErrorBox>,
        )
    }
</BaseLayout>
