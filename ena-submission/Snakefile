import yaml
from pathlib import Path

with open("config/config.yaml") as f:
    config = yaml.safe_load(f)

with open("config/defaults.yaml") as f:
    defaults = yaml.safe_load(f)

# Merge configs, using defaults only as fallback
# Write to results/config.yaml
for key, value in defaults.items():
    if not key in config:
        config[key] = value

Path("results").mkdir(parents=True, exist_ok=True)
with open("results/config.yaml", "w") as f:
    f.write(yaml.dump(config))

LOG_LEVEL = config.get("log_level", "INFO")
ORGANISMS = config['organisms'].keys()

WEBIN_USERNAME = "Webin-66038"
WEBIN_PASSWORD = ''


TEST_URL = "https://wwwdev.ebi.ac.uk/ena/submit/drop-box/submit"
# PRODUCTION_URL = "https://www.ebi.ac.uk/ena/submit/drop-box/submit"

URL = TEST_URL

rule submit_all_external_metadata:
    input:
        expand("results/submitted_{organism}.json", organism=ORGANISMS)
    
rule submit_external_metadata:
    input:
        script="scripts/call_loculus.py",
        metadata="results/external_metadata_{organism}.ndjson",
        config="results/config.yaml",
    output:
        submitted="results/submitted_{organism}.json"
    params:
        log_level=LOG_LEVEL,
    shell:
        """
        if [ -s {input.metadata} ]; then
            python {input.script} \
                --mode submit-external-metadata \
                --organism {wildcards.organism} \
                --metadata {input.metadata} \
                --config-file {input.config} \
                --output-file {output.submitted} \
                --log-level {params.log_level}
        fi
        """


rule get_ena_submission_list:
    input:
        script="scripts/get_ena_submission_list.py",
        config="results/config.yaml",
    output:
        released="results/ena_submission_list.json",
    params:
        log_level=LOG_LEVEL,
    shell:
        """
        python {input.script} \
                --config-file {input.config} \
                --output-file {output.released} \
                --log-level {params.log_level} \
        """

rule get_ena_submission_list_and_sleep:
    input:
        file="results/ena_submission_list.json"
    output:
        file="results/sleep.txt"
    shell:
        """
        sleep 360
        touch {output.file}
        """

rule create_project:
    """
    Create a project in ENA
    """
    input:
        project="results/project.xml",
        submission="resources/submission.xml",
    output:
        "results/project_accession.xml",
    params:
        username=WEBIN_USERNAME,
        password=WEBIN_PASSWORD,
        url=URL,
    shell:
        """
        curl -u {params.username}:{params.password} \
            -F "SUBMISSION=@{input.submission}" \
            -F "PROJECT=@{input.project}" \
            {params.url} \
        > {output}
        """